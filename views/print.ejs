<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å–∞–¥–∫–∏</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="print-container">
        <!-- –®–∞–ø–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <div class="print-header">
            <h1>üñ®Ô∏è –ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
            <a href="/" class="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–∞—Å—Å–∞–¥–∫–µ</a>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="print-controls-panel">
            <div class="controls-grid">
                <div>
                    <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ -->
                    <div class="control-group">
                        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="groupBy" value="classroom" checked>
                                <span class="radio-text">üè´ –ü–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="groupBy" value="school">
                                <span class="radio-text">üéì –ü–æ —à–∫–æ–ª–∞–º</span>
                            </label>
                        </div>
                    </div>

                    <!-- –§–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
                    <div class="control-group">
                        <label>–§–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="format" value="R" checked>
                                <span class="radio-text">üìã –§–æ—Ä–º–∞ –† (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="format" value="M">
                                <span class="radio-text">üìä –§–æ—Ä–º–∞ –ú (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)</span>
                            </label>
                        </div>
                    </div>

                    <!-- –í—ã–±–æ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞/—à–∫–æ–ª—ã -->
                    <div class="control-group" id="classroomGroup">
                        <label for="classroomSelect">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–±–∏–Ω–µ—Ç:</label>
                        <select id="classroomSelect" class="form-control">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–æ–≤...</option>
                        </select>
                    </div>

                    <div class="control-group" id="schoolGroup" style="display: none;">
                        <label for="schoolSelect">–í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É:</label>
                        <select id="schoolSelect" class="form-control">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —à–∫–æ–ª...</option>
                        </select>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="groupByParallel" checked>
                            üìä –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Å—Ç—ã –ø–æ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º
                        </label>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±–æ—Ä–µ -->
                    <div class="selection-info" id="selectionInfo" style="display: none;">
                        <p><strong>–†–µ–∂–∏–º:</strong> <span id="modeInfo">–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º</span></p>
                        <p><strong>–§–æ—Ä–º–∞—Ç:</strong> <span id="formatInfo">–§–æ—Ä–º–∞ –†</span></p>
                        <p><strong>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</strong> <span id="parallelInfo">–ø–æ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º</span></p>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="printBtn" class="btn btn-success" disabled>
                        üñ®Ô∏è –ü–µ—á–∞—Ç—å
                    </button>
                    <button id="exportExcelBtn" class="btn btn-info" disabled>
                        üìä Excel
                    </button>
                    <button id="bulkPrintBtn" class="btn btn-warning" disabled>
                        üöÄ –ú–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-info" id="statsInfo" style="display: none;">
            <p><strong>–í—ã–±–æ—Ä–∫–∞:</strong> <span id="selectionType">-</span></p>
            <p><strong>–£—á–µ–Ω–∏–∫–æ–≤:</strong> <span id="studentsCount">0</span></p>
            <p><strong>–ü–∞—Ä–∞–ª–ª–µ–ª–µ–π:</strong> <span id="parallelsCount">0</span></p>
            <p><strong>–†–µ–∂–∏–º:</strong> <span id="currentMode">-</span></p>
        </div>

        <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
        <div class="preview-section">
            <h2>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
            <div class="document-preview" id="documentPreview">
                <div class="no-preview">
                    –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ -->
        <div class="stats-info">
            <p><strong>–°–∏—Å—Ç–µ–º–∞ –ø–µ—á–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</strong></p>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º –† (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) –∏ –ú (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)</p>
            <p>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º –∏ —à–∫–æ–ª–∞–º | –í–µ—Ä—Å–∏—è 2.0</p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏ -->
    <div id="bulkPrintModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>üöÄ –ú–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å</h3>
            <div id="bulkPrintContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script src="/print.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—á–∞—Ç–∏
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—á–∞—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

            // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const groupByRadios = document.querySelectorAll('input[name="groupBy"]');
            const formatRadios = document.querySelectorAll('input[name="format"]');
            const groupByParallelCheckbox = document.getElementById('groupByParallel');
            const classroomGroup = document.getElementById('classroomGroup');
            const schoolGroup = document.getElementById('schoolGroup');
            const selectionInfo = document.getElementById('selectionInfo');
            const modeInfo = document.getElementById('modeInfo');
            const formatInfo = document.getElementById('formatInfo');
            const parallelInfo = document.getElementById('parallelInfo');
            const statsInfo = document.getElementById('statsInfo');
            const selectionType = document.getElementById('selectionType');
            const studentsCount = document.getElementById('studentsCount');
            const parallelsCount = document.getElementById('parallelsCount');
            const currentMode = document.getElementById('currentMode');
            const bulkPrintBtn = document.getElementById('bulkPrintBtn');
            const bulkPrintModal = document.getElementById('bulkPrintModal');

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±–æ—Ä–µ
            function updateSelectionInfo() {
                const groupBy = document.querySelector('input[name="groupBy"]:checked').value;
                const format = document.querySelector('input[name="format"]:checked').value;
                const isGrouped = groupByParallelCheckbox.checked;

                modeInfo.textContent = groupBy === 'classroom' ? '–ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º' : '–ø–æ —à–∫–æ–ª–∞–º';
                formatInfo.textContent = format === 'R' ? '–§–æ—Ä–º–∞ –†' : '–§–æ—Ä–º–∞ –ú';
                parallelInfo.textContent = isGrouped ? '–ø–æ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º' : '–µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫';

                selectionInfo.style.display = 'block';
                updateCurrentMode();
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
            function updateCurrentMode() {
                const groupBy = document.querySelector('input[name="groupBy"]:checked').value;
                const format = document.querySelector('input[name="format"]:checked').value;
                const isGrouped = groupByParallelCheckbox.checked;

                currentMode.textContent = `${groupBy === 'classroom' ? '–ö–∞–±–∏–Ω–µ—Ç—ã' : '–®–∫–æ–ª—ã'} | ${format === 'R' ? '–§–æ—Ä–º–∞ –†' : '–§–æ—Ä–º–∞ –ú'} | ${isGrouped ? '–ü–æ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º' : '–ï–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫'}`;
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            groupByRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'classroom') {
                        classroomGroup.style.display = 'block';
                        schoolGroup.style.display = 'none';
                        selectionType.textContent = '–ö–∞–±–∏–Ω–µ—Ç';
                    } else {
                        classroomGroup.style.display = 'none';
                        schoolGroup.style.display = 'block';
                        selectionType.textContent = '–®–∫–æ–ª–∞';
                        loadSchools(); // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —à–∫–æ–ª
                    }
                    updateSelectionInfo();
                    resetPreview();
                });
            });

            formatRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateSelectionInfo();
                    if (window.currentStudents && window.currentStudents.length > 0) {
                        updatePreview();
                    }
                });
            });

            groupByParallelCheckbox.addEventListener('change', function() {
                updateSelectionInfo();
                if (window.currentStudents && window.currentStudents.length > 0) {
                    updatePreview();
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏
            bulkPrintBtn.addEventListener('click', function() {
                showBulkPrintModal();
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.querySelector('#bulkPrintModal .close').addEventListener('click', function() {
                bulkPrintModal.style.display = 'none';
            });

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —à–∫–æ–ª (–∑–∞–≥–ª—É—à–∫–∞)
            function loadSchools() {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —à–∫–æ–ª...');
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —à–∫–æ–ª –∏–∑ API
            }

            // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø—Ä–µ–≤—å—é
            function resetPreview() {
                const preview = document.getElementById('documentPreview');
                preview.innerHTML = '<div class="no-preview">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>';
                statsInfo.style.display = 'none';
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏
            function showBulkPrintModal() {
                const groupBy = document.querySelector('input[name="groupBy"]:checked').value;
                const format = document.querySelector('input[name="format"]:checked').value;
                const isGrouped = groupByParallelCheckbox.checked;

                const content = `
                    <div class="bulk-print-options">
                        <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏</h4>
                        <p><strong>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</strong> ${groupBy === 'classroom' ? '–ü–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º' : '–ü–æ —à–∫–æ–ª–∞–º'}</p>
                        <p><strong>–§–æ—Ä–º–∞—Ç:</strong> ${format === 'R' ? '–§–æ—Ä–º–∞ –†' : '–§–æ—Ä–º–∞ –ú'}</p>
                        <p><strong>–ü–∞—Ä–∞–ª–ª–µ–ª–∏:</strong> ${isGrouped ? '–ü–æ –∫–ª–∞—Å—Å–∞–º' : '–ï–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫'}</p>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é:</label>
                            <select id="bulkSelection" class="form-control">
                                <option value="all">–í—Å–µ ${groupBy === 'classroom' ? '–∫–∞–±–∏–Ω–µ—Ç—ã' : '—à–∫–æ–ª—ã'}</option>
                                <option value="selected">–í—ã–±—Ä–∞–Ω–Ω—ã–µ</option>
                            </select>
                        </div>

                        <div class="action-buttons" style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="startBulkPrint()">
                                üöÄ –ù–∞—á–∞—Ç—å –ø–µ—á–∞—Ç—å
                            </button>
                            <button class="btn btn-secondary" onclick="closeBulkPrintModal()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('bulkPrintContent').innerHTML = content;
                bulkPrintModal.style.display = 'block';
            }

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏
            window.startBulkPrint = function() {
                const selection = document.getElementById('bulkSelection').value;
                console.log(`–ó–∞–ø—É—Å–∫ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏: ${selection}`);
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏
                alert(`–ú–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è: ${selection}`);
                bulkPrintModal.style.display = 'none';
            };

            window.closeBulkPrintModal = function() {
                bulkPrintModal.style.display = 'none';
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            updateSelectionInfo();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
            const originalUpdatePreview = window.updatePreview;
            window.updatePreview = function() {
                if (originalUpdatePreview) originalUpdatePreview();
                
                if (window.currentStudents && window.currentStudents.length > 0) {
                    statsInfo.style.display = 'block';
                    studentsCount.textContent = window.currentStudents.length;
                    
                    // –ü–æ–¥—Å—á–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–ª–ª–µ–ª–µ–π
                    const parallels = new Set();
                    window.currentStudents.forEach(student => {
                        parallels.add(student.–ø–∞—Ä–∞–ª–µ–ª—å);
                    });
                    parallelsCount.textContent = parallels.size;
                    
                    bulkPrintBtn.disabled = false;
                } else {
                    statsInfo.style.display = 'none';
                    bulkPrintBtn.disabled = true;
                }
            };
        });
    </script>
</body>
</html>