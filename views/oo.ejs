<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .record-card { border-left: 4px solid #667eea; margin-bottom: 1rem; }
        .btn-add { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-add:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .field-label { font-weight: 600; color: #495057; font-size: 0.9rem; }
        .field-value { color: #212529; margin-bottom: 0.5rem; }
        .field-row { border-bottom: 1px solid #e9ecef; padding: 0.5rem 0; }
        .field-row:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1><i class="fas fa-school me-2"></i><%= title %></h1>
                    <p class="mb-0">Управление данными образовательного учреждения</p>
                </div>
                <div class="col-auto">
                    <a href="/" class="btn btn-light">
                        <i class="fas fa-arrow-left me-1"></i>На главную
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <h3>Список учреждений</h3>
                    <button class="btn btn-add text-white" onclick="showAddModal()">
                        <i class="fas fa-plus me-1"></i>Добавить учреждение
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="loadingMessage" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных...</p>
                </div>
                
                <div id="ooList" class="d-none">
                    <!-- Данные будут загружены через JavaScript -->
                </div>
                
                <div id="emptyMessage" class="text-center py-4 d-none">
                    <i class="fas fa-school fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Нет данных об учреждениях</h4>
                    <p class="text-muted">Добавьте первое образовательное учреждение</p>
                    <button class="btn btn-add text-white" onclick="showAddModal()">
                        <i class="fas fa-plus me-1"></i>Добавить учреждение
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления/редактирования -->
    <div class="modal fade" id="ooModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Добавить учреждение</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ooForm">
                        <input type="hidden" id="recordId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="codeOmsu" class="form-label">Код ОМСУ</label>
                                <input type="text" class="form-control" id="codeOmsu" 
                                       placeholder="Введите код ОМСУ">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="codeOo" class="form-label">Код ОО</label>
                                <input type="text" class="form-control" id="codeOo" 
                                       placeholder="Введите код образовательного учреждения">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="numberOo" class="form-label">Номер ОО</label>
                                <input type="text" class="form-control" id="numberOo" 
                                       placeholder="Введите номер учреждения">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nameOo" class="form-label">Название ОО</label>
                                <input type="text" class="form-control" id="nameOo" 
                                       placeholder="Введите краткое название учреждения">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Полное наименование учреждения *</label>
                            <textarea class="form-control" id="fullName" rows="3" 
                                      placeholder="Введите полное наименование образовательного учреждения" required></textarea>
                            <div class="form-text">Обязательное поле</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveRecord()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ooModal = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            ooModal = new bootstrap.Modal(document.getElementById('ooModal'));
            loadOORecords();
        });

        function loadOORecords() {
            fetch('/api/oo')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingMessage').classList.add('d-none');
                    
                    if (data.success && data.oo.length > 0) {
                        displayOORecords(data.oo);
                    } else {
                        document.getElementById('emptyMessage').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных:', error);
                    document.getElementById('loadingMessage').classList.add('d-none');
                    alert('Ошибка загрузки данных');
                });
        }

        function displayOORecords(records) {
            const container = document.getElementById('ooList');
            container.innerHTML = '';
            container.classList.remove('d-none');
            
            records.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'card record-card';
                recordElement.innerHTML = `
                    <div class="card-body">
                        <div class="row align-items-start">
                            <div class="col-md-8">
                                <h5 class="card-title">${record.full_name || 'Не указано'}</h5>
                                <div class="row mt-3">
                                    <div class="col-sm-6">
                                        <div class="field-row">
                                            <div class="field-label">Код ОМСУ:</div>
                                            <div class="field-value">${record.code_omsu || 'Не указано'}</div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">Код ОО:</div>
                                            <div class="field-value">${record.code_oo || 'Не указано'}</div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">Номер ОО:</div>
                                            <div class="field-value">${record.number_oo || 'Не указано'}</div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="field-row">
                                            <div class="field-label">Название ОО:</div>
                                            <div class="field-value">${record.name_oo || 'Не указано'}</div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">ID записи:</div>
                                            <div class="field-value">${record.id}</div>
                                        </div>
                                        <div class="field-row">
                                            <div class="field-label">Обновлено:</div>
                                            <div class="field-value">${new Date(record.updated_at).toLocaleDateString('ru-RU')}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm me-1" onclick="editRecord(${record.id}, ${JSON.stringify(record).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-edit me-1"></i>Редактировать
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteRecord(${record.id})">
                                    <i class="fas fa-trash me-1"></i>Удалить
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(recordElement);
            });
        }

        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Добавить учреждение';
            document.getElementById('recordId').value = '';
            document.getElementById('codeOmsu').value = '';
            document.getElementById('codeOo').value = '';
            document.getElementById('numberOo').value = '';
            document.getElementById('nameOo').value = '';
            document.getElementById('fullName').value = '';
            ooModal.show();
        }

        function editRecord(id, record) {
            document.getElementById('modalTitle').textContent = 'Редактировать учреждение';
            document.getElementById('recordId').value = id;
            document.getElementById('codeOmsu').value = record.code_omsu || '';
            document.getElementById('codeOo').value = record.code_oo || '';
            document.getElementById('numberOo').value = record.number_oo || '';
            document.getElementById('nameOo').value = record.name_oo || '';
            document.getElementById('fullName').value = record.full_name || '';
            ooModal.show();
        }

        function saveRecord() {
            const id = document.getElementById('recordId').value;
            const codeOmsu = document.getElementById('codeOmsu').value.trim();
            const codeOo = document.getElementById('codeOo').value.trim();
            const numberOo = document.getElementById('numberOo').value.trim();
            const nameOo = document.getElementById('nameOo').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            
            if (!fullName) {
                alert('Пожалуйста, введите полное наименование учреждения');
                return;
            }

            const url = id ? `/api/oo/${id}` : '/api/oo';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    code_omsu: codeOmsu,
                    code_oo: codeOo,
                    number_oo: numberOo,
                    name_oo: nameOo,
                    full_name: fullName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    ooModal.hide();
                    loadOORecords();
                } else {
                    alert('Ошибка сохранения: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Ошибка сохранения:', error);
                alert('Ошибка сохранения данных');
            });
        }

        function deleteRecord(id) {
            if (!confirm('Вы уверены, что хотите удалить эту запись?')) {
                return;
            }

            fetch(`/api/oo/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadOORecords();
                } else {
                    alert('Ошибка удаления: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Ошибка удаления:', error);
                alert('Ошибка удаления данных');
            });
        }
    </script>
</body>
</html>